<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kubernetes API Timeline</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link href="static/css/fontawesome-6.4.2/css/fontawesome.min.css" rel="stylesheet">
  <link href="static/css/fontawesome-6.4.2/css/brands.min.css" rel="stylesheet">
  <link href="static/css/fontawesome-6.4.2/css/solid.min.css" rel="stylesheet">
  <link href="static/css/site.css" rel="stylesheet">
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Kubernetes API Timeline</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
        aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav me-auto mb-2 mb-md-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link</a>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled" aria-disabled="true">Disabled</a>
          </li>
        </ul>
      </div>
      <form class="d-flex" role="search">
        Show notable changes for:
        <select class="form-select" id="roi-selector">
          <option value="">(select release)</option>
          {{ range $idx, $rel := .Timeline.Releases }}
          {{ if gt $idx 0 }}
          <option value="{{ $rel.Version }}">Kubernetes {{ $rel.Version }}</option>
          {{ end }}
          {{ end }}
        </select>
      </form>
    </div>
  </nav>

  <!-- the main page container -->
  <main class="site-container">

    <!-- This 2 column div contains the mega table; it's two columns so that the right side table -->
    <!-- can be a responsive table and get horizontal scrolling while keeping the left column fixed. -->
    <table class="table" id="release-megatable">
      <thead>
        <tr>
          <th>&nbsp;</th>
          {{ range $idx, $rel := .Timeline.Releases }}
          <th
            class="{{ getReleaseHeaderClass $.Timeline $rel }}"
            data-release="{{ $rel.Version }}"
            data-released="{{ $rel.Released }}"
            data-latest-version="{{ $rel.LatestVersion }}"
            data-release-date="{{ $rel.ReleaseDate.Format "2006-01-02" }}"
            data-eol-date="{{ with $rel.EndOfLifeDate }}{{ .Format "2006-01-02" }}{{ end }}"
          >
            <a tabindex="{{ $idx }}" role="button" data-bs-toggle="popover" data-release="{{ $rel.Version }}">{{ $rel.Version }}</a>
          </th>
          {{ end }}
        </tr>
      </thead>

      {{ range $apiGroup := .Timeline.APIGroups }}
      <!-- TODO: collapsed should be applied via JS -->
      <tbody data-apigroup="{{ $apiGroup.Name }}" class="collapsed">
        <!-- row for the API group -->
        <tr class="{{ getAPIGroupClass $.Timeline $apiGroup }}">
          <th class="name">
            {{ $apiGroup.Name }}
            <span class="icons"><small><a href="#" class="toggle" title="expand/collapse this API group">⊕</a></small></span>
          </th>
          {{ range $rel := $.Timeline.Releases }}
          <td class="{{ getAPIGroupReleaseClass $.Timeline $apiGroup $rel }}">
            <span class="badge text-bg">{{ $apiGroup.PreferredVersion $rel.Version }}</span>
          </td>
          {{ end }}
        </tr>

        {{ range $apiVersionIdx, $apiVersion := $apiGroup.APIVersions }}
        <!-- row for the API version -->
        <!-- TODO: collapsed should be applied via JS -->
        <tr class="{{ getAPIVersionClass $.Timeline $apiGroup $apiVersion }} collapsed" data-apiversion="{{ $apiVersion.Version }}">
          <th class="name">
            <span class="hidden">{{ $apiGroup.Name }}/</span>{{ $apiVersion.Version }}
            <span class="icons"><small><a href="#" class="toggle" title="expand/collapse this API version">⊕</a></small></span>
          </th>
          {{ range $rel := $.Timeline.Releases }}
          <td class="{{ getAPIVersionReleaseClass $.Timeline $apiGroup $apiVersion $rel }}">
            <span class="badge text-bg">{{ getAPIVersionReleaseContent $.Timeline $apiGroup $apiVersion $rel }}</span>
          </td>
          {{ end }}
        </tr>

        {{ range $apiResource := $apiVersion.Resources }}
        <!-- row for an API resource -->
        <tr class="{{ getAPIResourceClass $.Timeline $apiGroup $apiVersion $apiResource }}" data-apiversion="{{ $apiVersion.Version }}" data-apiresource="{{ $apiResource.Plural }}">
          <th class="name">
            <span title="{{ $apiResource.Description }}">{{ $apiResource.Kind }}</span>
            <span class="icons"><small><a href="#" class="docs" title="view documentation for most recent Kubernetes release">⛿</a></small></span>
          </th>
          {{ range $rel := $.Timeline.Releases }}
          <td class="{{ getAPIResourceReleaseClass $.Timeline $apiGroup $apiVersion $apiResource $rel }}">
            <span class="badge text-bg">{{ getAPIResourceReleaseContent $.Timeline $apiGroup $apiVersion $apiResource $rel }}</span>
          </td>
          {{ end }}
        </tr>
        {{ end }}
        {{ end }}
      </tbody>
      {{ end }}
      <tfoot>
        <tr class="no-notable-changes">
          <th>&nbsp;</th>
          <!-- colspan is always 3 because in ROI mode we show the release itself plus 2 preceding releases -->
          <td colspan="{{ len .Timeline.Releases }}" class="infotext">There are no notable API changes in this release.<br><i class="fa-solid fa-face-smile-beam"></i></td>
        </tr>
      </tfoot>
    </table>
  </main> <!-- main content done -->

  <footer>
    <p class="text-center text-body-secondary border-top">
      Distributed under CC BY 4.0
    </p>
    <p class="text-center text-body-secondary">
      Kubernetes® is a registered trademark of The Linux Foundation®. All rights reserved.<br>
      This website has no relation with and is not endorsed by The Linux Foundation.
    </p>
  </footer>

  <div class="hidden">
    <div class="release-popover-template">
      <ul class="list-group list-group-flush release-links">
        <li class="list-group-item after-release">
          <a class="release-documentation" target="_blank">
            <i class="fa-solid fa-book"></i> Documentation
          </a>
        </li>
        <li class="list-group-item after-release">
          <a class="release-changelog" target="_blank">
            <i class="fa-solid fa-clipboard-list"></i> Changelog
          </a>
        </li>
        <li class="list-group-item after-release">
          <a class="release-gitbranch" target="_blank">
            <i class="fa-solid fa-github"></i> Git Branch
          </a>
        </li>
        <li class="list-group-item dl-item">
          <div class="key">Released:</div>
          <div class="release-date value"></div>
        </li>
        <li class="list-group-item dl-item">
          <div class="key">Latest Version:</div>
          <div class="latest-version value"></div>
        </li>
        <li class="list-group-item dl-item after-release">
          <div class="key">End of Life:</div>
          <div class="eol-date value"></div>
        </li>
      </ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
  <script>
    // thank you https://stackoverflow.com/a/15289883
    function dateDiffInDays(a, b) {
      const _MS_PER_DAY = 1000 * 60 * 60 * 24;
      // Discard the time and time-zone information.
      const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
      const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());

      return Math.floor((utc2 - utc1) / _MS_PER_DAY);
    }

    // very rough results are totally acceptable here, a day or two is not
    // important, considering timezones
    function dateDiffString(now, other) {
      let diff = dateDiffInDays(now, other);
      if (diff < 0) {
        return '';
      }

      switch (diff) {
        case 0:
          return ' (today!)'
        case 1:
          return ' (tomorrow)'
        default:
          if (diff > 60) {
            let months = Math.floor(diff / 30.5);
            return ` (in ${months} months)`;
          }

          return ` (in ${diff} days)`
      }
    }

    function showReleaseInfoPopover(link) {
      let cell = link.closest('th');
      let release = cell.dataset.release;
      let template = document.querySelector('.release-popover-template').cloneNode(true);
      let now = new Date();

      let releaseDate = 'TBD';
      if (cell.dataset.releaseDate) {
        let parsed = new Date(cell.dataset.releaseDate);
        releaseDate = parsed.toDateString() + dateDiffString(now, parsed);
      }

      let eolDate = 'TBD';
      if (cell.dataset.eolDate) {
        let parsed = new Date(cell.dataset.eolDate);
        eolDate = parsed.toDateString() + dateDiffString(now, parsed);
      }

      let latestVersion = '(unreleased)';
      if (cell.dataset.latestVersion) {
        latestVersion = cell.dataset.latestVersion;
      }

      // Hide additional infos if the release isn't out yet;
      // do not rely on the browser date, as some release information
      // depends on buildtime data and so making it client-dependent
      // would not magically make more data appear.
      let container = template.querySelector('.release-links');
      container.classList.toggle('unreleased', cell.dataset.released !== 'true');

      template.querySelector('.release-date').innerText = releaseDate;
      template.querySelector('.latest-version').innerText = latestVersion;
      template.querySelector('.eol-date').innerText = eolDate;

      template.querySelector('.release-documentation').href = `apidocs/${release}/`;
      template.querySelector('.release-changelog').href = `https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-${release}.md`;
      template.querySelector('.release-gitbranch').href = `https://github.com/kubernetes/kubernetes/tree/release-${release}`;

      return template.innerHTML;
    }

    var visiblePopover = null;

    const popoverTriggerList = document.querySelectorAll('thead th.release [data-bs-toggle="popover"]')
    const popoverList = [...popoverTriggerList].map(function (popoverTriggerEl) {
      let popper = new bootstrap.Popover(popoverTriggerEl, {
        html:      true,
        content:   showReleaseInfoPopover,
        placement: 'bottom',
        trigger:   'manual',
      });

      popoverTriggerEl.addEventListener('click', function(e) {
        if (visiblePopover !== null) {
          visiblePopover.hide();
        }

        popper.show();
        visiblePopover = popper;

        // hijack the click event
        e.preventDefault();

        // prevent the body's listener from immediately closing the popover again
        e.stopPropagation();
      });
    });

    // close popovers _only_ when clicking outside them
    document.body.addEventListener('click', function(e) {
      let target = e.target;

      // no popover visible
      if (visiblePopover === null) {
        return;
      }

      // clicked on a popover trigger element, ignore
      if (target.dataset.toggle === 'popover') {
        return;
      }

      // clicked inside a popover
      if (target.closest('.popover') !== null) {
        return;
      }

      visiblePopover.hide();
      visiblePopover = null;
    });

    // tbodies cannot be nested, so besides 1 tbody per APIGroup, there is no
    // further nesting in the megatable; but APIResources should still logically
    // be grouped below APIVersions, so to simulate this, we have to manually
    // apply the "hidden" class for all APIResources which have their APIVersion
    // collapsed;
    // This "hidden" class has then also be kept in-sync with the collapsed status.
    function updateAPIResourcesVisibility(apiversionRow) {
      let isCollapsed     = apiversionRow.classList.contains("collapsed");
      let apiVersion      = apiversionRow.dataset.apiversion;
      let apiGroupBody    = apiversionRow.closest('tbody');
      let apiResourceRows = apiGroupBody.querySelectorAll('tr.apiresource[data-apiversion="' + apiVersion + '"]');

      apiResourceRows.forEach(function(row) {
        row.classList.toggle("hidden", isCollapsed);
      });
    }

    // initial setup
    document.querySelectorAll('tr.apiversion').forEach(updateAPIResourcesVisibility);

    // toggle visibility of APIVersions for an APIGroup
    document.querySelectorAll('tr.apigroup a.toggle').forEach(function(node) {
      node.addEventListener("click", function(e) {
        let apigroupRow  = this.closest('tr');
        let apigroupBody = apigroupRow.closest('tbody');
        let apigroup     = apigroupBody.dataset.apigroup;

        // toggle visibility in legend table
        apigroupBody.classList.toggle("collapsed");

        // update icon
        this.innerText = apigroupBody.classList.contains("collapsed") ? '⊕' : '⊙';

        e.preventDefault();
      });
    });

    // toggle visibility of APIResources for an APIVersion
    document.querySelectorAll('tr.apiversion a.toggle').forEach(function(node) {
      node.addEventListener("click", function(e) {
        let apiversionRow = this.closest('tr');
        let apiversion    = apiversionRow.dataset.apiversion;
        let apigroupBody  = apiversionRow.closest('tbody');
        let apigroup      = apigroupBody.dataset.apigroup;

        // toggle visibility in legend table
        apiversionRow.classList.toggle("collapsed");
        updateAPIResourcesVisibility(apiversionRow);

        // update icon
        this.innerText = apiversionRow.classList.contains("collapsed") ? '⊕' : '⊙';

        e.preventDefault();
      });
    });

    // handle ROI dropdown changes
    let selector = document.querySelector('#roi-selector');
    let megatable = document.querySelector('#release-megatable');
    let releaseColumns = document.querySelectorAll('th.release');

    function roiClass(release) {
      return 'roi-' + release.replace('.', '-');
    }

    function updateROIState() {
      let selectedRelease = selector.value;

      megatable.classList.toggle('roi-mode', selectedRelease != '');
      megatable.classList.toggle('container', selectedRelease != '');

      // reset any other class
      releaseColumns.forEach(function(col) {
        megatable.classList.remove('show-' + roiClass(col.dataset.release));
      });

      // set the currently selected column
      let selectedRoiClass = roiClass(selectedRelease);
      megatable.classList.add('show-' + selectedRoiClass);

      // if after all this no rows are visible, show a special row that
      // mentions no breaks
      let unremarkable = megatable.querySelectorAll('tbody tr.apigroup.' + selectedRoiClass).length === 0;
      megatable.classList.toggle('unremarkable', unremarkable);
    }

    selector.addEventListener('change', updateROIState);
    updateROIState();
  </script>
</body>

</html>
